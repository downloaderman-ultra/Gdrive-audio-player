<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Music Player Ver.1.5.9.9</title>
    <style>
        /* スタイルは簡略化していますが、必要に応じて調整してください */
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
        .controls { margin-top: 30px; display: flex; justify-content: center; gap: 20px; }
        button { padding: 15px 25px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; }
        .active { background-color: #1DB954; color: white; }
        #song-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        #folder-name { font-size: 14px; color: #aaa; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="loading-overlay">接続中...</div>
    
    <div id="folder-name">---</div>
    <div id="song-title">再生停止中</div>
    
    <div class="controls">
        <button id="prevBtn">Prev</button>
        <button id="bigPlay" class="active">再生</button>
        <button id="pauseBtn" style="display:none;">一時停止</button>
        <button id="nextBtn">Next</button>
    </div>

    <audio id="audioPlayer"></audio>

    <script>
        // 設定と状態管理
        let accessToken = null;
        let allTracks = []; // 全フォルダの曲リスト
        let playQueue = []; // シャッフルされた再生キュー
        let currentIndex = -1;
        let lastUpdateTime = 0;
        
        const audio = document.getElementById('audioPlayer');
        const bigPlay = document.getElementById('bigPlay');
        const pauseBtn = document.getElementById('pauseBtn');

        // 1. 初期化と認証管理 (Ver.1.5.9.4: 1時間の壁対策)
        function gisLoaded() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: 'YOUR_CLIENT_ID', // 設定済みのID
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (response) => {
                    accessToken = response.access_token;
                    startApp();
                }
            });
            // 50分ごとにトークンをサイレント更新
            setInterval(() => client.requestAccessToken({prompt: ''}), 50 * 60 * 1000);
            client.requestAccessToken({prompt: ''});
        }

        // 2. メディアセッションの初期化 (Ver.1.5.9.0: 重複登録防止)
        function initMediaSession() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => audio.play());
                navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                navigator.mediaSession.setActionHandler('previoustrack', () => handlePrev());
                navigator.mediaSession.setActionHandler('nexttrack', () => handleNext());
            }
        }

        // 3. フォルダ跨ぎシャッフルロジック (Ver.1.5.9.7)
        function createSmartShuffle(filesByFolder) {
            let folders = Object.keys(filesByFolder);
            // フォルダ順をシャッフル
            folders.sort(() => Math.random() - 0.5);
            
            let queue = [];
            let maxFiles = Math.max(...folders.map(f => filesByFolder[f].length));

            for (let i = 0; i < maxFiles; i++) {
                folders.forEach(folder => {
                    if (filesByFolder[folder][i]) {
                        queue.push(filesByFolder[folder][i]);
                    }
                });
            }
            return queue; // 各フォルダから1曲ずつ取り出したリスト
        }

        // 4. 再生処理 (Ver.1.5.9.1 & 1.5.9.6)
        async function playTrack(index) {
            if (index < 0 || index >= playQueue.length) return;
            currentIndex = index;
            const track = playQueue[index];

            document.getElementById('song-title').innerText = track.name;
            document.getElementById('folder-name').innerText = track.folderName;

            const url = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`;
            
            // 旧リソースの解放 (メモリリーク対策)
            if (audio.src) URL.revokeObjectURL(audio.src);

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const blob = await response.blob();
            audio.src = URL.createObjectURL(blob);
            
            audio.play();
            updateMediaMetadata(track);
        }

        // 5. インテリジェントな「戻る」 (Ver.1.5.9.6)
        function handlePrev() {
            if (audio.currentTime > 3) {
                audio.currentTime = 0; // 3秒以上再生なら頭出し
            } else {
                playTrack(currentIndex - 1); // 3秒以内なら前の曲
            }
        }

        function handleNext() {
            playTrack(currentIndex + 1);
        }

        // 6. OSへの通知スロットリング (Ver.1.5.9.1)
        audio.ontimeupdate = () => {
            const now = Date.now();
            if (now - lastUpdateTime > 1000) { // 1秒間隔に制限
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.setPositionState({
                        duration: audio.duration || 0,
                        playbackRate: audio.playbackRate,
                        position: audio.currentTime
                    });
                }
                lastUpdateTime = now;
            }
        };

        // 自動再生
        audio.onended = () => handleNext();

        // 初期化実行
        window.onload = () => {
            initMediaSession();
        };

        function startApp() {
            // ここでGoogle Driveからファイル取得・フィルタリング・シャッフル等の初期化を実行
            console.log("App Started with Access Token");
            document.getElementById('loading-overlay').style.display = 'none';
        }
    </script>
</body>
</html>

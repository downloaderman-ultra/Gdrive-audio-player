<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Music Ver.1.1.8</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 10px; position: relative; }
        .version-tag { position: absolute; top: 10px; right: 15px; font-size: 0.7rem; color: #666; }
        h1 { font-size: 1.2rem; margin: 10px 0; }
        
        #song-title { margin: 15px 0; font-weight: bold; color: #1DB954; font-size: 1.1rem; min-height: 2.4em; display: flex; align-items: center; justify-content: center; padding: 0 10px; }
        
        .control-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            max-width: 450px; 
            margin: 0 auto 10px; 
        }
        
        button, select { 
            background: #333; color: white; border: none; padding: 12px 2px; 
            border-radius: 6px; cursor: pointer; font-size: 13px; width: 100%;
            transition: 0.1s;
        }
        button:active { background: #555; transform: scale(0.98); }
        button.active { background: #1DB954; color: #fff; font-weight: bold; }
        
        select { text-align: center; text-align-last: center; appearance: none; border: 1px solid #444; }

        .big-play-btn {
            width: 100%; max-width: 450px; margin: 0 auto 8px; display: block;
            background: #333; font-size: 1.2rem; font-weight: bold; padding: 15px;
        }
        .big-play-btn.active { background: #1DB954; }

        .scope-controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            max-width: 450px; margin: 0 auto 10px;
        }
        .scope-btn { background: #222; border: 1px solid #444; color: #888; }
        .scope-btn.active { background: #1DB954; color: white; border-color: #1DB954; }

        .volume-controls {
            max-width: 450px; margin: 0 auto 10px;
            display: flex; align-items: center; gap: 10px;
            background: #222; padding: 8px 15px; border-radius: 6px;
        }
        .volume-label { font-size: 0.8rem; color: #aaa; white-space: nowrap; }
        input[type=range] {
            width: 100%; cursor: pointer; accent-color: #1DB954; height: 4px;
        }

        #visualizer-container {
            max-width: 600px; margin: 0 auto 10px;
            height: 60px; background: #1a1a1a; border-radius: 8px;
            overflow: hidden; border: 1px solid #333;
        }
        #visualizer { width: 100%; height: 100%; display: block; }

        .content-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; max-width: 600px; margin: 0 auto; height: 40vh; }
        .list-box { background: #1e1e1e; border-radius: 8px; overflow-y: auto; border: 1px solid #333; text-align: left; padding: 5px; }
        .list-box h4 { font-size: 0.8rem; margin: 5px; color: #888; border-bottom: 1px solid #333; padding-bottom: 3px; text-align: center; }
        
        .item-btn { width: 100%; text-align: left; background: transparent; padding: 12px 5px; border-radius: 4px; font-size: 13px; border-bottom: 1px solid #252525; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; color: #ccc; }
        .item-btn:active { background: #333; }
        .item-btn.playing { color: #1DB954; font-weight: bold; background: #222; }
        .item-btn.current-folder { color: #fff; border-left: 3px solid #1DB954; }

        .hidden { display: none !important; }
        .timer-info { max-width: 450px; margin: -5px auto 10px; font-size: 0.75rem; color: #aaa; min-height: 1em; }
    </style>
</head>
<body>

    <div class="version-tag">Ver.1.1.8</div>
    <h1>G-Drive Music</h1>
    
    <button id="auth-btn" class="hidden" onclick="handleAuthClick()" style="max-width:200px; margin:20px auto;">Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«æ¥ç¶š</button>
    <div id="song-title">æ¥ç¶šä¸­...</div>

    <div id="main-ui" class="hidden">
        <div class="control-grid">
            <button onclick="changeMode('normal')" id="mode-normal" class="active">é †æ¬¡</button>
            <button onclick="changeMode('shuffle')" id="mode-shuffle">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            <button onclick="toggleRepeat()" id="repeat-btn">ãƒªãƒ”ãƒ¼ãƒˆ: OFF</button>
            
            <button onclick="prevTrack()">å‰ã¸</button>
            <button onclick="skip(10)">+10ç§’</button>
            <select id="sleep-timer" onchange="setSleepTimer()">
                <option value="0">ã‚¿ã‚¤ãƒãƒ¼: OFF</option>
                <option value="30">30åˆ†å¾Œ</option>
                <option value="60">60åˆ†å¾Œ</option>
                <option value="120">120åˆ†å¾Œ</option>
                <option value="180">180åˆ†å¾Œ</option>
            </select>
            
            <button onclick="nextTrack()">æ¬¡ã¸</button>
            <button onclick="skip(-10)">-10ç§’</button>
            <button onclick="audio.pause()" id="btn-pause">ä¸€æ™‚åœæ­¢</button>
        </div>

        <button onclick="resumeOrPlay()" id="big-play-btn" class="big-play-btn">å†ç”Ÿ</button>

        <div class="scope-controls">
            <button onclick="changeScope('folder')" id="scope-folder" class="scope-btn active">ãƒ•ã‚©ãƒ«ãƒ€å†…å†ç”Ÿ</button>
            <button onclick="changeScope('all')" id="scope-all" class="scope-btn">å…¨ãƒ•ã‚©ãƒ«ãƒ€å†ç”Ÿ</button>
        </div>

        <div class="volume-controls">
            <span class="volume-label">VOL</span>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1.0">
        </div>

        <div id="visualizer-container">
            <canvas id="visualizer"></canvas>
        </div>

        <div id="timer-display" class="timer-info"></div>

        <div class="content-grid">
            <div class="list-box">
                <h4>ãƒ•ã‚©ãƒ«ãƒ€</h4>
                <div id="folder-list"></div>
            </div>
            <div class="list-box">
                <h4>æ›²ãƒªã‚¹ãƒˆ</h4>
                <div id="song-list"></div>
            </div>
        </div>
    </div>

    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script>
        const CLIENT_ID = '870566274257-1e240kru9vef55k8ke7odf522tn7i864.apps.googleusercontent.com';
        const PARENT_ID = '1t5V8v-i-cYsOG9DcDveR2SzJp1JO5Uwj';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        const STORE_KEY = 'gdrive_music_state';

        let tokenClient, accessToken = null;
        let allFolders = [];
        let playlist = [], currentIndex = 0;
        let isShuffle = false, repeatMode = 0, playScope = 'folder'; 
        let sleepTimeout = null, sleepInterval = null;
        let currentFolderId = null, currentFolderName = "";
        let isRetry = false; // å†è©¦è¡Œãƒ•ãƒ©ã‚°

        const audio = document.getElementById('audio-player');
        const volumeSlider = document.getElementById('volume-slider');

        // Web Audio & Visualizer
        let audioCtx, analyser, dataArray, canvas, canvasCtx, animationId;
        let isAudioContextInitialized = false;

        volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value;
            saveSettings(); 
        });

        function gapiLoaded() { gapi.load('client', () => {}); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) { document.getElementById('auth-btn').classList.remove('hidden'); return; }
                    accessToken = resp.access_token;
                    document.getElementById('auth-btn').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                    // å†è©¦è¡Œä¸­ãªã‚‰å³åº§ã«æ›²ãƒ­ãƒ¼ãƒ‰ã¸æˆ»ã‚‹
                    if (isRetry) {
                         isRetry = false;
                         if(playlist.length > 0) playTrack(currentIndex);
                         else initApp();
                    } else {
                        initApp();
                    }
                },
            });
            tokenClient.requestAccessToken({ prompt: '' });
        }

        function handleAuthClick() { tokenClient.requestAccessToken({ prompt: 'select_account' }); }

        // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ç”¨é–¢æ•°
        function refreshAccessToken() {
            console.log("Refreshing token...");
            isRetry = true;
            tokenClient.requestAccessToken({ prompt: '' });
        }

        async function initApp() {
            const saved = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
            if (saved.isShuffle !== undefined) changeMode(saved.isShuffle ? 'shuffle' : 'normal');
            if (saved.repeatMode !== undefined) { repeatMode = saved.repeatMode - 1; toggleRepeat(); }
            if (saved.playScope !== undefined) changeScope(saved.playScope);
            if (saved.volume !== undefined) { volumeSlider.value = saved.volume; audio.volume = saved.volume; }

            canvas = document.getElementById('visualizer');
            canvasCtx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            await loadFolders();
            
            if (saved.folderId) {
                loadSongs(saved.folderId, saved.folderName, false);
            } else {
                document.getElementById('song-title').innerText = "ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„";
            }
        }

        function initAudioContext() {
            if (isAudioContextInitialized) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64; // è² è·è»½æ¸›ã®ãŸã‚ã‚µã‚¤ã‚ºã‚’ç¸®å°
                const source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioContextInitialized = true;
                drawVisualizer();
            } catch(e) { console.error("AudioContext init error:", e); }
        }

        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }

        function drawVisualizer() {
            animationId = requestAnimationFrame(drawVisualizer);
            if(!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            canvasCtx.fillStyle = '#1a1a1a';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;
            for(let i = 0; i < dataArray.length; i++) {
                barHeight = (dataArray[i] / 255) * canvas.height;
                canvasCtx.fillStyle = '#1DB954';
                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        function saveSettings() {
            const settings = {
                folderId: currentFolderId, folderName: currentFolderName,
                isShuffle: isShuffle, repeatMode: repeatMode, playScope: playScope, volume: volumeSlider.value 
            };
            localStorage.setItem(STORE_KEY, JSON.stringify(settings));
        }

        async function loadFolders() {
            try {
                const query = `'${PARENT_ID}' in parents and mimeType = 'application/vnd.google-apps.folder'`;
                const resp = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                
                if(resp.status === 401) { refreshAccessToken(); return; } // ãƒˆãƒ¼ã‚¯ãƒ³åˆ‡ã‚Œå¯¾å¿œ

                const data = await resp.json();
                allFolders = data.files.sort((a,b)=>a.name.localeCompare(b.name,'ja'));
                const listEl = document.getElementById('folder-list');
                listEl.innerHTML = '';
                allFolders.forEach(f => {
                    const btn = document.createElement('div');
                    btn.className = 'item-btn';
                    if(f.id === currentFolderId) btn.classList.add('current-folder');
                    btn.id = `folder-${f.id}`;
                    btn.innerText = "ğŸ“ " + f.name;
                    btn.onclick = () => loadSongs(f.id, f.name, true);
                    listEl.appendChild(btn);
                });
            } catch(e) { console.error(e); }
        }

        async function loadSongs(folderId, folderName, autoPlay) {
            currentFolderId = folderId;
            currentFolderName = folderName;
            saveSettings();

            document.getElementById('song-title').innerText = `${folderName} ã‚’èª­è¾¼ä¸­...`;
            document.querySelectorAll('#folder-list .item-btn').forEach(b => b.classList.remove('current-folder'));
            document.getElementById(`folder-${folderId}`)?.classList.add('current-folder');

            try {
                const query = `'${folderId}' in parents and mimeType contains 'audio/'`;
                const resp = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                
                if(resp.status === 401) { refreshAccessToken(); return; }

                const data = await resp.json();
                playlist = data.files.sort((a,b)=>a.name.localeCompare(b.name,'ja'));
                
                const listEl = document.getElementById('song-list');
                listEl.innerHTML = '';
                playlist.forEach((s, idx) => {
                    const btn = document.createElement('div');
                    btn.className = 'item-btn';
                    btn.id = `song-${idx}`;
                    btn.innerText = s.name;
                    btn.onclick = () => playTrack(idx);
                    listEl.appendChild(btn);
                });
                
                document.getElementById('song-title').innerText = `${folderName} (${playlist.length}æ›²)`;
                
                if (playlist.length === 0) {
                    document.getElementById('song-title').innerText = `${folderName} (ãƒ•ã‚¡ã‚¤ãƒ«ãªã—)`;
                    if (autoPlay && playScope === 'all') {
                        setTimeout(() => { 
                           // ã‚¹ã‚­ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯
                           if (isShuffle) {
                                const randomFolder = allFolders[Math.floor(Math.random() * allFolders.length)];
                                loadSongs(randomFolder.id, randomFolder.name, true);
                            } else {
                                const currentFolderIndex = allFolders.findIndex(f => f.id === currentFolderId);
                                const nextFolderIndex = (currentFolderIndex + 1) % allFolders.length;
                                const nextFolder = allFolders[nextFolderIndex];
                                if (nextFolder.id !== currentFolderId) loadSongs(nextFolder.id, nextFolder.name, true);
                            }
                        }, 500);
                        return;
                    }
                }

                if (autoPlay && playlist.length > 0) {
                    if(playScope === 'all' && isShuffle) {
                        playTrack(Math.floor(Math.random() * playlist.length));
                    } else {
                        playTrack(0);
                    }
                }
            } catch(e) { console.error(e); }
        }

        function resumeOrPlay() {
            // å¼·åˆ¶çš„ã«Contextã‚’å†é–‹
            initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

            if (audio.src && audio.src !== window.location.href) {
                // ã‚¨ãƒ©ãƒ¼ã§æ­¢ã¾ã£ã¦ã„ãŸå ´åˆã®ãƒªãƒ­ãƒ¼ãƒ‰
                if (audio.error) {
                    audio.load(); 
                }
                audio.play().catch(e => console.log("Play failed, need load"));
            } else if (playlist.length > 0) {
                playTrack(currentIndex);
            }
        }

        function playTrack(index) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã«å¿…ãšContextã‚’å†é–‹
            initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

            if (playlist.length === 0) return;
            currentIndex = index;
            const track = playlist[index];
            
            document.querySelectorAll('#song-list .item-btn').forEach(el => el.classList.remove('playing'));
            const activeBtn = document.getElementById(`song-${index}`);
            if (activeBtn) {
                activeBtn.classList.add('playing');
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            document.getElementById('song-title').innerText = track.name;

            // â˜…é‡è¦: å¤ã„ãƒãƒƒãƒ•ã‚¡ã‚’å¼·åˆ¶ç ´æ£„
            audio.pause();
            audio.removeAttribute('src');
            audio.load(); 

            const fetchUrl = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`;
            fetch(fetchUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } })
                .then(r => { 
                    if (r.status === 401) { throw new Error('401'); } // 401ã¯catchãƒ–ãƒ­ãƒƒã‚¯ã¸
                    if (!r.ok) throw new Error(r.status); 
                    return r.blob(); 
                })
                .then(blob => {
                    audio.src = URL.createObjectURL(blob);
                    audio.volume = volumeSlider.value;
                    
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Auto-play prevented or interrupted:", error);
                        });
                    }
                    updateMediaSession(track.name);
                })
                .catch(err => {
                    console.error("Play error:", err);
                    if(err.message === '401' || err.message.includes('401')) {
                        // â˜…è‡ªå‹•å¾©æ—§ãƒã‚¤ãƒ³ãƒˆ
                        refreshAccessToken(); 
                    }
                });
        }

        // ... nextTrack, prevTrack, changeScope, toggleRepeat, changeMode ...
        // ã“ã‚Œã‚‰ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥ã›ãšè¨˜è¿°
        
        function nextTrack() {
            if (repeatMode === 2) { playTrack(currentIndex); return; }
            if (playScope === 'all' && isShuffle) {
                const randomFolder = allFolders[Math.floor(Math.random() * allFolders.length)];
                loadSongs(randomFolder.id, randomFolder.name, true);
                return;
            }
            let next = isShuffle ? Math.floor(Math.random() * playlist.length) : (currentIndex + 1);
            if (next >= playlist.length) {
                if (repeatMode === 1) next = 0; 
                else if (playScope === 'all') {
                    const currentFolderIndex = allFolders.findIndex(f => f.id === currentFolderId);
                    const nextFolderIndex = (currentFolderIndex + 1) % allFolders.length;
                    loadSongs(allFolders[nextFolderIndex].id, allFolders[nextFolderIndex].name, true);
                    return;
                } else { audio.pause(); return; }
            }
            playTrack(next);
        }

        function prevTrack() { playTrack((currentIndex - 1 + playlist.length) % playlist.length); }
        function changeScope(scope) {
            playScope = scope;
            document.getElementById('scope-folder').className = `scope-btn ${scope === 'folder' ? 'active' : ''}`;
            document.getElementById('scope-all').className = `scope-btn ${scope === 'all' ? 'active' : ''}`;
            saveSettings();
        }
        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const labels = ["OFF", "ALL", "1æ›²"];
            document.getElementById('repeat-btn').innerText = "ãƒªãƒ”ãƒ¼ãƒˆ: " + labels[repeatMode];
            document.getElementById('repeat-btn').classList.toggle('active', repeatMode > 0);
            saveSettings();
        }
        function changeMode(m) {
            isShuffle = (m === 'shuffle');
            document.getElementById('mode-shuffle').classList.toggle('active', isShuffle);
            document.getElementById('mode-normal').classList.toggle('active', !isShuffle);
            saveSettings();
        }
        function setSleepTimer() {
            const mins = parseInt(document.getElementById('sleep-timer').value);
            clearTimeout(sleepTimeout); clearInterval(sleepInterval);
            const display = document.getElementById('timer-display');
            if (mins === 0) { display.innerText = ""; return; }
            let endTime = Date.now() + mins * 60000;
            display.innerText = `ã‚¿ã‚¤ãƒãƒ¼è¨­å®š: ${mins}åˆ†å¾Œã«åœæ­¢`;
            sleepInterval = setInterval(() => {
                let remain = Math.round((endTime - Date.now()) / 60000);
                display.innerText = remain > 0 ? `æ®‹ã‚Š ${remain}åˆ†` : "åœæ­¢ä¸­...";
            }, 10000);
            sleepTimeout = setTimeout(() => {
                const fade = setInterval(() => {
                    if (audio.volume > 0.1) audio.volume -= 0.1; else { audio.pause(); clearInterval(fade); clearInterval(sleepInterval); audio.volume = volumeSlider.value; display.innerText = "åœæ­¢ã—ã¾ã—ãŸ"; }
                }, 500);
            }, mins * 60000);
        }
        function skip(s) { audio.currentTime += s; }
        
        audio.onended = nextTrack;
        audio.onplay = () => updatePlayPauseUI(true);
        audio.onpause = () => updatePlayPauseUI(false);
        // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯æ¬¡ã¸è¡Œã‹ãšã«æ­¢ã‚ã‚‹ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰ã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å¾…ã¤
        audio.onerror = () => { console.log("Audio Error"); };

        function updatePlayPauseUI(isPlaying) {
            const bigPlay = document.getElementById('big-play-btn');
            const pauseBtn = document.getElementById('btn-pause');
            if (isPlaying) {
                bigPlay.classList.add('active'); bigPlay.innerText = "å†ç”Ÿä¸­"; pauseBtn.classList.remove('active');
            } else {
                bigPlay.classList.remove('active'); bigPlay.innerText = "å†ç”Ÿ"; pauseBtn.classList.add('active');
            }
        }

        function updateMediaSession(title) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({ title, artist: 'G-Drive Music' });
                navigator.mediaSession.setActionHandler('play', () => { resumeOrPlay(); });
                navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
                navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
            }
        }

        // ç”»é¢å¾©å¸°æ™‚ã®ãƒã‚§ãƒƒã‚¯
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                // ãƒˆãƒ¼ã‚¯ãƒ³ãŒåˆ‡ã‚Œã¦ã„ãã†ãªã‚‰ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã®ã‚‚æ‰‹ã ãŒã€
                // å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã«refreshAccessToken()ãŒèµ°ã‚‹ã‚ˆã†ã«playTrackã§åˆ¶å¾¡æ¸ˆã¿
            }
        });
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>

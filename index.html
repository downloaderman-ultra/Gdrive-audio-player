<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"><!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Music Player Ver.1.1</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 20px; position: relative; }
        .version-tag { position: absolute; top: 10px; right: 15px; font-size: 0.8rem; color: #666; font-family: monospace; }
        h1 { margin-top: 30px; font-size: 1.5rem; }
        .controls, .folder-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 400px; margin: 20px auto; }
        button { background: #333; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; transition: 0.1s; font-size: 14px; }
        button:active { background: #555; transform: scale(0.95); }
        button.active { background: #1DB954; }
        .folder-btn { background: #444; border: 1px solid #666; }
        #song-title { margin: 20px 0; font-weight: bold; min-height: 1.2em; color: #1DB954; font-size: 1.1rem; padding: 0 10px; }
        #back-btn { background: #666; margin-bottom: 20px; width: 100%; max-width: 400px; }
        .timer-info { color: #aaa; font-size: 0.8em; margin-top: 8px; min-height: 1em; }
        .hidden { display: none !important; }
        select { background: #333; color: white; border: 1px solid #666; padding: 10px; border-radius: 10px; width: 100%; max-width: 400px; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="version-tag">Ver.1.1</div>
    <h1>G-Drive Music</h1>
    
    <button id="auth-btn" class="hidden" onclick="handleAuthClick()">Googleドライブに接続</button>
    
    <div id="song-title">接続を確認中...</div>

    <div id="folder-container" class="hidden">
        <h3>再生するフォルダを選択</h3>
        <div id="folder-list" class="folder-list"></div>
    </div>

    <div id="player-container" class="hidden">
        <button id="back-btn" onclick="showFolderList()">← フォルダ一覧に戻る</button>
        <div class="controls">
            <button onclick="changeMode('normal')" id="mode-normal" class="active">順次</button>
            <button onclick="changeMode('shuffle')" id="mode-shuffle">シャッフル</button>
            <button onclick="toggleRepeat()" id="repeat-btn">リピート: OFF</button>
            <select id="sleep-timer" onchange="setSleepTimer()">
                <option value="0">スリープタイマー: OFF</option>
                <option value="30">30分後にフェードアウト</option>
                <option value="60">60分後にフェードアウト</option>
                <option value="90">90分後にフェードアウト</option>
                <option value="120">120分後にフェードアウト</option>
                <option value="150">150分後にフェードアウト</option>
                <option value="180">180分後にフェードアウト</option>
            </select>
            <div id="timer-display" class="timer-info" style="grid-column: span 2;"></div>
            <button onclick="skip(-10)">-10秒</button>
            <button onclick="skip(10)">+10秒</button>
            <button onclick="prevTrack()">前へ</button>
            <button onclick="nextTrack()">次へ</button>
            <button onclick="togglePlay()" id="play-btn" style="grid-column: span 2; background: #1DB954; font-weight: bold; font-size: 1.1rem;">再生</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        const CLIENT_ID = '870566274257-1e240kru9vef55k8ke7odf522tn7i864.apps.googleusercontent.com';
        const PARENT_FOLDER_ID = '1t5V8v-i-cYsOG9DcDveR2SzJp1JO5Uwj';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        const STORAGE_KEY = 'gdrive_music_autologin';

        let tokenClient, accessToken = null, playlist = [], currentIndex = 0;
        let isShuffle = false, repeatMode = 0, sleepTimeout = null, sleepInterval = null;
        const audio = document.getElementById('audio-player');

        function gapiLoaded() { gapi.load('client', () => {}); }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) {
                        document.getElementById('auth-btn').classList.remove('hidden');
                        document.getElementById('song-title').innerText = "ログインが必要です";
                        return;
                    }
                    accessToken = resp.access_token;
                    localStorage.setItem(STORAGE_KEY, 'true');
                    document.getElementById('auth-btn').classList.add('hidden');
                    loadSubFolders();
                },
            });
            // ページ読み込み時に自動ログインを試行
            if (localStorage.getItem(STORAGE_KEY)) {
                tokenClient.requestAccessToken({ prompt: '' });
            } else {
                document.getElementById('auth-btn').classList.remove('hidden');
                document.getElementById('song-title').innerText = "ログインしてください";
            }
        }

        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        async function loadSubFolders() {
            document.getElementById('song-title').innerText = "フォルダを確認中...";
            try {
                const query = `'${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder'`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                
                if (response.status === 401) { // トークン切れ対応
                    tokenClient.requestAccessToken({ prompt: '' });
                    return;
                }

                const data = await response.json();
                const listEl = document.getElementById('folder-list');
                listEl.innerHTML = '';
                if (data.files && data.files.length > 0) {
                    data.files.sort((a, b) => a.name.localeCompare(b.name, 'ja')).forEach(folder => {
                        const btn = document.createElement('button');
                        btn.className = 'folder-btn';
                        btn.innerText = folder.name;
                        btn.onclick = () => loadMusicFiles(folder.id, folder.name);
                        listEl.appendChild(btn);
                    });
                    document.getElementById('folder-container').classList.remove('hidden');
                    document.getElementById('song-title').innerText = "フォルダを選んでください";
                } else { loadMusicFiles(PARENT_FOLDER_ID, "すべての曲"); }
            } catch (e) { console.error(e); }
        }

        async function loadMusicFiles(folderId, folderName) {
            document.getElementById('song-title').innerText = `${folderName} を読み込み中...`;
            try {
                const query = `'${folderId}' in parents and mimeType = 'audio/mpeg'`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await response.json();
                playlist = data.files.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                if (playlist.length > 0) {
                    document.getElementById('folder-container').classList.add('hidden');
                    document.getElementById('player-container').classList.remove('hidden');
                    playTrack(0);
                } else { alert("MP3がありません。"); loadSubFolders(); }
            } catch (e) { alert("エラー: " + e.message); }
        }

        function playTrack(index) {
            if (playlist.length === 0) return;
            currentIndex = index;
            const track = playlist[index];
            fetch(`https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`, { headers: { 'Authorization': `Bearer ${accessToken}` } })
                .then(resp => resp.blob())
                .then(blob => {
                    if (audio.src) URL.revokeObjectURL(audio.src);
                    audio.src = URL.createObjectURL(blob);
                    audio.volume = 1.0;
                    audio.play();
                    document.getElementById('song-title').innerText = track.name;
                    document.getElementById('play-btn').innerText = "一時停止";
                    if ('mediaSession' in navigator) { 
                        navigator.mediaSession.metadata = new MediaMetadata({ title: track.name, artist: 'G-Drive Music Ver.1.1' }); 
                    }
                });
        }

        function togglePlay() {
            if (audio.paused) { audio.play(); document.getElementById('play-btn').innerText = "一時停止"; }
            else { audio.pause(); document.getElementById('play-btn').innerText = "再生"; }
        }

        function nextTrack() {
            if (repeatMode === 2) { playTrack(currentIndex); return; }
            let next;
            if (isShuffle) { next = Math.floor(Math.random() * playlist.length); }
            else {
                next = currentIndex + 1;
                if (next >= playlist.length) {
                    if (repeatMode === 1) next = 0; else { audio.pause(); return; }
                }
            }
            playTrack(next);
        }

        function prevTrack() { let prev = (currentIndex - 1 + playlist.length) % playlist.length; playTrack(prev); }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const labels = ["リピート: OFF", "リピート: ALL", "リピート: 1曲"];
            const btn = document.getElementById('repeat-btn');
            btn.innerText = labels[repeatMode];
            btn.classList.toggle('active', repeatMode > 0);
        }

        function fadeOut() {
            const display = document.getElementById('timer-display');
            display.innerText = "フェードアウト中...";
            const fadeInterval = setInterval(() => {
                if (audio.volume > 0.05) { audio.volume -= 0.05; } 
                else {
                    audio.pause();
                    clearInterval(fadeInterval);
                    audio.volume = 1.0;
                    display.innerText = "スリープ実行済み";
                    document.getElementById('play-btn').innerText = "再生";
                }
            }, 500); 
        }

        function setSleepTimer() {
            const mins = parseInt(document.getElementById('sleep-timer').value);
            clearTimeout(sleepTimeout);
            clearInterval(sleepInterval);
            const display = document.getElementById('timer-display');
            if (mins === 0) { display.innerText = ""; return; }
            let endTime = Date.now() + mins * 60000;
            display.innerText = `あと ${mins} 分でフェードアウト`;
            sleepInterval = setInterval(() => {
                let remain = Math.round((endTime - Date.now()) / 60000);
                if (remain <= 0) { clearInterval(sleepInterval); } 
                else { display.innerText = `あと ${remain} 分でフェードアウト`; }
            }, 10000);
            sleepTimeout = setTimeout(() => { fadeOut(); }, mins * 60000);
        }

        function skip(sec) { audio.currentTime += sec; }
        function showFolderList() { audio.pause(); document.getElementById('player-container').classList.add('hidden'); loadSubFolders(); }
        function changeMode(mode) {
            isShuffle = (mode === 'shuffle');
            document.getElementById('mode-shuffle').classList.toggle('active', isShuffle);
            document.getElementById('mode-normal').classList.toggle('active', !isShuffle);
        }
        audio.onended = nextTrack;
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
    <title>G-Drive Music Player Ver.1.0</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 20px; position: relative; }
        
        /* バージョン表示 (右上) */
        .version-tag { 
            position: absolute; top: 10px; right: 15px; 
            font-size: 0.8rem; color: #666; font-family: monospace;
        }

        h1 { margin-top: 30px; font-size: 1.5rem; }
        .controls, .folder-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 400px; margin: 20px auto; }
        
        button { 
            background: #333; color: white; border: none; padding: 15px; 
            border-radius: 10px; cursor: pointer; transition: 0.1s; font-size: 14px; 
        }
        button:active { background: #555; transform: scale(0.95); }
        button.active { background: #1DB954; }
        
        .folder-btn { background: #444; border: 1px solid #666; }
        #song-title { margin: 20px 0; font-weight: bold; min-height: 1.2em; color: #1DB954; font-size: 1.1rem; padding: 0 10px; }
        
        #back-btn { background: #666; margin-bottom: 20px; width: 100%; max-width: 400px; }
        .timer-info { color: #aaa; font-size: 0.8em; margin-top: 8px; min-height: 1em; }
        .hidden { display: none !important; }
        
        select { 
            background: #333; color: white; border: 1px solid #666; padding: 10px; 
            border-radius: 10px; width: 100%; max-width: 400px; margin-top: 10px; font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="version-tag">Ver.1.0</div>
    <h1>G-Drive Music</h1>
    
    <button id="auth-btn" onclick="handleAuthClick()">Googleドライブに接続</button>
    
    <div id="song-title">ログインしてください</div>

    <div id="folder-container" class="hidden">
        <h3>再生するフォルダを選択</h3>
        <div id="folder-list" class="folder-list"></div>
    </div>

    <div id="player-container" class="hidden">
        <button id="back-btn" onclick="showFolderList()">← フォルダ一覧に戻る</button>
        
        <div class="controls">
            <button onclick="changeMode('normal')" id="mode-normal" class="active">順次</button>
            <button onclick="changeMode('shuffle')" id="mode-shuffle">シャッフル</button>
            
            <button onclick="toggleRepeat()" id="repeat-btn">リピート: OFF</button>
            
            <select id="sleep-timer" onchange="setSleepTimer()">
                <option value="0">スリープタイマー: OFF</option>
                <option value="30">30分後にフェードアウト</option>
                <option value="60">60分後にフェードアウト</option>
                <option value="90">90分後にフェードアウト</option>
                <option value="120">120分後にフェードアウト</option>
                <option value="150">150分後にフェードアウト</option>
                <option value="180">180分後にフェードアウト</option>
            </select>
            <div id="timer-display" class="timer-info" style="grid-column: span 2;"></div>

            <button onclick="skip(-10)">-10秒</button>
            <button onclick="skip(10)">+10秒</button>
            <button onclick="prevTrack()">前へ</button>
            <button onclick="nextTrack()">次へ</button>
            <button onclick="togglePlay()" id="play-btn" style="grid-column: span 2; background: #1DB954; font-weight: bold; font-size: 1.1rem;">再生</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        const CLIENT_ID = '870566274257-1e240kru9vef55k8ke7odf522tn7i864.apps.googleusercontent.com';
        const PARENT_FOLDER_ID = '1t5V8v-i-cYsOG9DcDveR2SzJp1JO5Uwj';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        let tokenClient, accessToken = null, playlist = [], currentIndex = 0;
        let isShuffle = false;
        let repeatMode = 0; // 0: OFF, 1: ALL, 2: 1曲
        let sleepTimeout = null, sleepInterval = null;

        const audio = document.getElementById('audio-player');

        function gapiLoaded() { gapi.load('client', () => {}); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    accessToken = resp.access_token;
                    document.getElementById('auth-btn').classList.add('hidden');
                    loadSubFolders();
                },
            });
        }
        function handleAuthClick() { tokenClient.requestAccessToken({prompt: 'consent'}); }

        async function loadSubFolders() {
            document.getElementById('song-title').innerText = "フォルダを確認中...";
            try {
                const query = `'${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder'`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await response.json();
                const listEl = document.getElementById('folder-list');
                listEl.innerHTML = '';
                if (data.files && data.files.length > 0) {
                    data.files.sort((a, b) => a.name.localeCompare(b.name, 'ja')).forEach(folder => {
                        const btn = document.createElement('button');
                        btn.className = 'folder-btn';
                        btn.innerText = folder.name;
                        btn.onclick = () => loadMusicFiles(folder.id, folder.name);
                        listEl.appendChild(btn);
                    });
                    document.getElementById('folder-container').classList.remove('hidden');
                    document.getElementById('song-title').innerText = "フォルダを選んでください";
                } else { loadMusicFiles(PARENT_FOLDER_ID, "すべての曲"); }
            } catch (e) { alert("エラー: " + e.message); }
        }

        async function loadMusicFiles(folderId, folderName) {
            document.getElementById('song-title').innerText = `${folderName} を読み込み中...`;
            try {
                const query = `'${folderId}' in parents and mimeType = 'audio/mpeg'`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await response.json();
                playlist = data.files.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                if (playlist.length > 0) {
                    document.getElementById('folder-container').classList.add('hidden');
                    document.getElementById('player-container').classList.remove('hidden');
                    playTrack(0);
                } else { alert("MP3がありません。"); loadSubFolders(); }
            } catch (e) { alert("エラー: " + e.message); }
        }

        function playTrack(index) {
            if (playlist.length === 0) return;
            currentIndex = index;
            const track = playlist[index];
            fetch(`https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`, { headers: { 'Authorization': `Bearer ${accessToken}` } })
                .then(resp => resp.blob())
                .then(blob => {
                    if (audio.src) URL.revokeObjectURL(audio.src);
                    audio.src = URL.createObjectURL(blob);
                    audio.volume = 1.0;
                    audio.play();
                    document.getElementById('song-title').innerText = track.name;
                    document.getElementById('play-btn').innerText = "一時停止";
                    if ('mediaSession' in navigator) { 
                        navigator.mediaSession.metadata = new MediaMetadata({ title: track.name, artist: 'G-Drive Music Ver.1.0' }); 
                    }
                });
        }

        function togglePlay() {
            if (audio.paused) { audio.play(); document.getElementById('play-btn').innerText = "一時停止"; }
            else { audio.pause(); document.getElementById('play-btn').innerText = "再生"; }
        }

        function nextTrack() {
            if (repeatMode === 2) { playTrack(currentIndex); return; }
            let next;
            if (isShuffle) { next = Math.floor(Math.random() * playlist.length); }
            else {
                next = currentIndex + 1;
                if (next >= playlist.length) {
                    if (repeatMode === 1) next = 0; else { audio.pause(); return; }
                }
            }
            playTrack(next);
        }

        function prevTrack() { let prev = (currentIndex - 1 + playlist.length) % playlist.length; playTrack(prev); }

        function toggleRepeat() {
            repeatMode = (repeatMode + 1) % 3;
            const labels = ["リピート: OFF", "リピート: ALL", "リピート: 1曲"];
            const btn = document.getElementById('repeat-btn');
            btn.innerText = labels[repeatMode];
            btn.classList.toggle('active', repeatMode > 0);
        }

        function fadeOut() {
            const display = document.getElementById('timer-display');
            display.innerText = "フェードアウト中...";
            const fadeInterval = setInterval(() => {
                if (audio.volume > 0.05) {
                    audio.volume -= 0.05;
                } else {
                    audio.pause();
                    clearInterval(fadeInterval);
                    audio.volume = 1.0;
                    display.innerText = "スリープ実行済み";
                    document.getElementById('play-btn').innerText = "再生";
                }
            }, 500); 
        }

        function setSleepTimer() {
            const mins = parseInt(document.getElementById('sleep-timer').value);
            clearTimeout(sleepTimeout);
            clearInterval(sleepInterval);
            const display = document.getElementById('timer-display');
            
            if (mins === 0) { display.innerText = ""; return; }

            let endTime = Date.now() + mins * 60000;
            display.innerText = `あと ${mins} 分でフェードアウト`;

            sleepInterval = setInterval(() => {
                let remain = Math.round((endTime - Date.now()) / 60000);
                if (remain <= 0) { clearInterval(sleepInterval); } 
                else { display.innerText = `あと ${remain} 分でフェードアウト`; }
            }, 10000);

            sleepTimeout = setTimeout(() => { fadeOut(); }, mins * 60000);
        }

        function skip(sec) { audio.currentTime += sec; }
        function showFolderList() { audio.pause(); document.getElementById('player-container').classList.add('hidden'); loadSubFolders(); }
        function changeMode(mode) {
            isShuffle = (mode === 'shuffle');
            document.getElementById('mode-shuffle').classList.toggle('active', isShuffle);
            document.getElementById('mode-normal').classList.toggle('active', !isShuffle);
        }
        audio.onended = nextTrack;
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>


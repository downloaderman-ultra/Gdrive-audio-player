<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Player Ver.1.5.9.12</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; text-align: center; margin: 0; padding: 20px; box-sizing: border-box; }
        #canvas { width: 100%; height: 200px; background: #111; margin-top: 10px; border-bottom: 1px solid #333; }
        .info-area { margin: 15px 0; min-height: 60px; }
        #folder-name { color: #888; font-size: 14px; margin-bottom: 5px; }
        #song-title { font-size: 18px; font-weight: bold; color: #fff; word-break: break-all; }
        
        /* メインボタン（元のスタイル） */
        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        .controls button { padding: 15px 25px; font-size: 16px; cursor: pointer; border-radius: 5px; border: 1px solid #444; background: #222; color: #fff; }
        .active-btn { background-color: #0f0 !important; color: #000 !important; font-weight: bold; border: none !important; }

        /* 最下部メニュー（指示通り：均等幅3列） */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; height: 60px; background: #1a1a1a; border-top: 1px solid #333;
        }
        .nav-btn {
            flex: 1; border: none; border-right: 1px solid #333;
            background: transparent; color: #aaa; font-size: 13px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:last-child { border-right: none; }
        .nav-btn:active { background: #333; color: #fff; }

        /* ログ画面 */
        #log-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; display: none;
            flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        #log-display {
            flex: 1; background: #111; border: 1px solid #444; color: #ccc;
            text-align: left; padding: 10px; overflow-y: auto; font-size: 11px;
            white-space: pre-wrap; font-family: monospace; margin-bottom: 15px;
        }
        .log-tools { display: flex; gap: 10px; }
        .log-tools button { flex: 1; padding: 15px; cursor: pointer; background: #333; color: #fff; border: 1px solid #555; }

        .hidden { display: none !important; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:2000; }
    </style>
</head>
<body>

    <div id="loading">接続中...</div>

    <div class="info-area">
        <div id="folder-name">---</div>
        <div id="song-title">Music Player</div>
    </div>
    
    <canvas id="canvas"></canvas>

    <div class="controls">
        <button id="prevBtn">Prev</button>
        <button id="bigPlay" class="active-btn">再生</button>
        <button id="pauseBtn" class="hidden">停止</button>
        <button id="nextBtn">Next</button>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn" onclick="changeMode('folder')">フォルダ内</button>
        <button class="nav-btn" onclick="changeMode('all')">全フォルダ内</button>
        <button class="nav-btn" onclick="showLog()">Log</button>
    </div>

    <div id="log-overlay">
        <h3 style="color:#0f0; margin-top:0;">System Logs</h3>
        <div id="log-display">ログはありません</div>
        <div class="log-tools">
            <button onclick="copyLog()">コピー</button>
            <button onclick="hideLog()">閉じる</button>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous"></audio>

    <script>
        // ログから抽出したクライアントIDを適用済み
        const CLIENT_ID = '870566274257-1e240kru9vef55k8ke7odf522tn7i864.apps.googleusercontent.com';

        let accessToken = null;
        let allFiles = [];
        let playQueue = [];
        let currentIndex = 0;
        let isExplicitPause = false;
        let logs = [];

        let audioCtx, analyser, source, canvas, canvasCtx;
        const audio = document.getElementById('audioPlayer');

        // --- ログ機能 ---
        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            logs.push(`[${time}] ${msg}`);
            document.getElementById('log-display').innerText = logs.join('\n');
            const d = document.getElementById('log-display');
            d.scrollTop = d.scrollHeight;
        }
        function showLog() { document.getElementById('log-overlay').style.display = 'flex'; }
        function hideLog() { document.getElementById('log-overlay').style.display = 'none'; }
        function copyLog() {
            navigator.clipboard.writeText(logs.join('\n')).then(() => alert("ログをコピーしました"));
        }

        // --- 認証 ---
        function gisLoaded() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.readonly',
                callback: (resp) => {
                    accessToken = resp.access_token;
                    addLog("Auth Success");
                    fetchFileList();
                }
            });
            client.requestAccessToken({prompt: ''});
            setInterval(() => client.requestAccessToken({prompt: ''}), 50 * 60 * 1000);
        }

        // --- ファイルリスト取得 ---
        async function fetchFileList() {
            try {
                const query = encodeURIComponent("mimeType contains 'audio/' and trashed = false");
                const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,parents)`;
                
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await res.json();
                allFiles = data.files || [];
                
                addLog(`Found ${allFiles.length} files`);
                changeMode('all');
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                addLog("Fetch Error: " + e.message);
            }
        }

        // --- シャッフルモード切替 ---
        function changeMode(mode) {
            addLog(`Mode: ${mode}`);
            if (mode === 'all') {
                playQueue = [...allFiles].sort(() => Math.random() - 0.5);
            } else {
                const current = playQueue[currentIndex];
                const folderId = (current && current.parents) ? current.parents[0] : (allFiles[0] ? allFiles[0].parents[0] : null);
                if (!folderId) return;
                playQueue = allFiles.filter(f => f.parents && f.parents[0] === folderId).sort(() => Math.random() - 0.5);
            }
            currentIndex = 0;
            addLog(`Queue: ${playQueue.length} tracks`);
            document.getElementById('song-title').innerText = "リスト更新(再生待ち)";
        }

        // --- 再生処理 ---
        async function playTrack(idx) {
            if (idx < 0) idx = playQueue.length - 1;
            if (idx >= playQueue.length) idx = 0;
            currentIndex = idx;
            const track = playQueue[idx];
            
            isExplicitPause = false;
            document.getElementById('song-title').innerText = track.name;
            document.getElementById('folder-name').innerText = `[${idx+1}/${playQueue.length}]`;
            
            toggleUI(true);

            try {
                if (audio.src) URL.revokeObjectURL(audio.src);
                const res = await fetch(`https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const blob = await res.blob();
                audio.src = URL.createObjectURL(blob);
                
                if (!audioCtx) initVisualizer();
                audio.play();
                addLog(`Start: ${track.name}`);
                setupMediaSession(track);
            } catch (e) {
                addLog(`Skip Error: ${track.name}`);
                setTimeout(next, 1000);
            }
        }

        // --- ビジュアライザー ---
        function initVisualizer() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            canvas = document.getElementById('canvas');
            canvasCtx = canvas.getContext('2d');
            draw();
        }

        function draw() {
            requestAnimationFrame(draw);
            const data = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(data);
            canvasCtx.fillStyle = '#111';
            canvasCtx.fillRect(0,0,canvas.width,canvas.height);
            const barWidth = (canvas.width / data.length) * 2.5;
            data.forEach((val, i) => {
                canvasCtx.fillStyle = `rgb(0,${val+100},50)`;
                canvasCtx.fillRect(i*barWidth, canvas.height - val/2, barWidth-1, val/2);
            });
        }

        function next() { playTrack(currentIndex + 1); }
        function prev() { 
            if (audio.currentTime > 3) audio.currentTime = 0;
            else playTrack(currentIndex - 1); 
        }

        // --- 自動救済ロジック ---
        audio.onpause = () => {
            if (audio.currentTime < audio.duration - 0.5 && !isExplicitPause) {
                addLog("!! 異常停止検知 -> スキップ");
                setTimeout(next, 1500);
            }
        };
        audio.onended = next;

        function toggleUI(playing) {
            if (playing) {
                document.getElementById('bigPlay').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('active-btn');
            } else {
                document.getElementById('bigPlay').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('bigPlay').classList.add('active-btn');
            }
        }

        function setupMediaSession(track) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({ title: track.name, artist: 'G-Drive Player' });
                navigator.mediaSession.setActionHandler('play', () => { isExplicitPause=false; audio.play(); toggleUI(true); });
                navigator.mediaSession.setActionHandler('pause', () => { isExplicitPause=true; audio.pause(); toggleUI(false); });
                navigator.mediaSession.setActionHandler('previoustrack', prev);
                navigator.mediaSession.setActionHandler('nexttrack', next);
            }
        }

        document.getElementById('bigPlay').onclick = () => { isExplicitPause=false; audio.play(); toggleUI(true); };
        document.getElementById('pauseBtn').onclick = () => { isExplicitPause=true; audio.pause(); toggleUI(false); addLog("User Pause"); };
        document.getElementById('nextBtn').onclick = next;
        document.getElementById('prevBtn').onclick = prev;

    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

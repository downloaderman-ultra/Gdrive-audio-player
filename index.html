<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Music Ver.1.5.9.1</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 10px; position: relative; display: flex; flex-direction: column; height: 95vh; }
        .version-tag { position: absolute; top: 10px; right: 15px; font-size: 0.7rem; color: #666; }
        h1 { font-size: 1.1rem; margin: 5px 0; color: #888; }
        
        #song-title { margin: 10px 0; font-weight: bold; color: #1DB954; font-size: 1.1rem; min-height: 2.4em; display: flex; align-items: center; justify-content: center; padding: 0 10px; }
        
        .content-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 8px; max-width: 600px; margin: 0 auto 10px; flex-grow: 1; min-height: 0; width: 100%; }
        .list-box { background: #1e1e1e; border-radius: 8px; overflow-y: auto; border: 1px solid #333; text-align: left; padding: 5px; display: flex; flex-direction: column; }
        .list-box h4 { font-size: 0.75rem; margin: 3px; color: #666; border-bottom: 1px solid #333; padding-bottom: 3px; text-align: center; flex-shrink: 0; }
        .scroll-area { flex-grow: 1; overflow-y: auto; }
        
        .item-btn { width: 100%; text-align: left; background: transparent; padding: 12px 5px; border-radius: 4px; font-size: 13px; border-bottom: 1px solid #252525; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; color: #ccc; }
        .item-btn:active { background: #333; }
        .item-btn.playing { color: #1DB954; font-weight: bold; background: #222; }
        .item-btn.current-folder { color: #fff; border-left: 3px solid #1DB954; }

        .bottom-controls { flex-shrink: 0; padding-top: 10px; background: #121212; }
        .control-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; max-width: 450px; margin: 0 auto 8px; }
        button, select { background: #333; color: white; border: none; padding: 12px 2px; border-radius: 6px; cursor: pointer; font-size: 13px; width: 100%; }
        button:active { background: #555; transform: scale(0.96); }
        button.active { background: #1DB954; color: #fff; font-weight: bold; }
        select { text-align: center; text-align-last: center; appearance: none; border: 1px solid #444; }

        .big-play-btn { width: 100%; max-width: 450px; margin: 0 auto 8px; display: block; background: #333; font-size: 1.2rem; font-weight: bold; padding: 15px; }
        .big-play-btn.active { background: #1DB954; }

        .scope-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; max-width: 450px; margin: 0 auto 8px; }
        .scope-btn { background: #222; border: 1px solid #444; color: #888; }
        .scope-btn.active { background: #1DB954; color: white; border-color: #1DB954; }

        .volume-controls { max-width: 450px; margin: 0 auto 8px; display: flex; align-items: center; gap: 10px; background: #222; padding: 8px 15px; border-radius: 6px; }
        .volume-label { font-size: 0.7rem; color: #aaa; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #1DB954; height: 4px; }

        #visualizer-container { max-width: 450px; margin: 0 auto 5px; height: 40px; background: #1a1a1a; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        #visualizer { width: 100%; height: 100%; display: block; }

        .hidden { display: none !important; }
        .timer-info { max-width: 450px; margin: 0 auto 5px; font-size: 0.7rem; color: #888; min-height: 1em; }
    </style>
</head>
<body>

    <div class="version-tag">Ver.1.5.9.1</div>
    <h1>G-Drive Music</h1>
    
    <button id="auth-btn" class="hidden" onclick="handleAuthClick()" style="max-width:200px; margin:20px auto;">Googleドライブに接続</button>
    <div id="song-title">接続中...</div>

    <div id="main-ui" class="hidden" style="display: flex; flex-direction: column; flex-grow: 1; min-height: 0;">
        
        <div class="content-grid">
            <div class="list-box">
                <h4>フォルダ</h4>
                <div id="folder-list" class="scroll-area"></div>
            </div>
            <div class="list-box">
                <h4>曲リスト</h4>
                <div id="song-list" class="scroll-area"></div>
            </div>
        </div>

        <div class="bottom-controls">
            <div id="visualizer-container">
                <canvas id="visualizer"></canvas>
            </div>
            <div id="timer-display" class="timer-info"></div>
            <div class="control-grid">
                <button onclick="changeMode('normal')" id="mode-normal" class="active">順次</button>
                <button onclick="changeMode('shuffle')" id="mode-shuffle">シャッフル</button>
                <button onclick="toggleRepeat()" id="repeat-btn">リピート: OFF</button>
                <button onclick="prevTrack()">戻り</button>
                <button onclick="skip(10)">+10秒</button>
                <select id="sleep-timer" onchange="setSleepTimer()">
                    <option value="0">タイマー: OFF</option>
                    <option value="30">30分</option>
                    <option value="60">60分</option>
                    <option value="120">120分</option>
                    <option value="180">180分</option>
                </select>
                <button onclick="nextTrack()">送り</button>
                <button onclick="skip(-10)">-10秒</button>
                <button onclick="audio.pause()" id="btn-pause">一時停止</button>
            </div>
            <button onclick="resumeOrPlay()" id="big-play-btn" class="big-play-btn">再生</button>
            <div class="scope-controls">
                <button onclick="changeScope('folder')" id="scope-folder" class="scope-btn active">フォルダ内</button>
                <button onclick="changeScope('all')" id="scope-all" class="scope-btn">全フォルダ</button>
            </div>
            <div class="volume-controls">
                <span class="volume-label">VOL</span>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1.0">
            </div>
        </div>
    </div>

    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script>
        const CLIENT_ID = '870566274257-1e240kru9vef55k8ke7odf522tn7i864.apps.googleusercontent.com';
        const PARENT_ID = '1t5V8v-i-cYsOG9DcDveR2SzJp1JO5Uwj';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        const STORE_KEY = 'gdrive_music_state';

        let tokenClient, accessToken = null;
        let allFolders = [], playlist = [], currentIndex = 0;
        let isShuffle = false, repeatMode = 0, playScope = 'folder'; 
        let sleepTimeout = null, sleepInterval = null;
        let currentFolderId = null, currentFolderName = "";
        let isRetry = false;
        let lastPositionUpdate = 0; // ★スロットリング用

        const audio = document.getElementById('audio-player');
        const volumeSlider = document.getElementById('volume-slider');

        let audioCtx, analyser, dataArray, canvas, canvasCtx, animationId;
        let isAudioContextInitialized = false;

        const ARTWORK_DATA = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAAVklEQVRo3u3RAREAMAwDkZm/6RqmEA0fLgW1790dPCZgAibgGiZgAibgGiZgAibgGiZgAibgGiZgAibgGiZgAibgGiZgAibgGiZgAibgGiZgAibgGibgAS76A/1z768hAAAAAElFTkSuQmCC';

        volumeSlider.addEventListener('input', (e) => { audio.volume = e.target.value; saveSettings(); });

        function gapiLoaded() { gapi.load('client', () => {}); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) { document.getElementById('auth-btn').classList.remove('hidden'); return; }
                    accessToken = resp.access_token;
                    document.getElementById('auth-btn').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                    if (isRetry) { isRetry = false; if(playlist.length > 0) playTrack(currentIndex); else initApp(); }
                    else initApp();
                },
            });
            tokenClient.requestAccessToken({ prompt: '' });
        }

        function handleAuthClick() { tokenClient.requestAccessToken({ prompt: 'select_account' }); }
        function refreshAccessToken() { isRetry = true; tokenClient.requestAccessToken({ prompt: '' }); }

        async function initApp() {
            const saved = JSON.parse(localStorage.getItem(STORE_KEY) || '{}');
            if (saved.isShuffle !== undefined) changeMode(saved.isShuffle ? 'shuffle' : 'normal');
            if (saved.repeatMode !== undefined) { repeatMode = saved.repeatMode - 1; toggleRepeat(); }
            if (saved.playScope !== undefined) changeScope(saved.playScope);
            if (saved.volume !== undefined) { volumeSlider.value = saved.volume; audio.volume = saved.volume; }
            
            setupMediaSessionHandlers();

            canvas = document.getElementById('visualizer');
            canvasCtx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            await loadFolders();
            if (saved.folderId) loadSongs(saved.folderId, saved.folderName, false);
            else document.getElementById('song-title').innerText = "フォルダを選択してください";
        }

        function initAudioContext() {
            if (isAudioContextInitialized) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64; 
                const source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioContextInitialized = true;
                drawVisualizer();
            } catch(e) { console.error("Visualizer Error:", e); }
        }

        function resizeCanvas() { canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }

        function drawVisualizer() {
            animationId = requestAnimationFrame(drawVisualizer);
            if(!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            canvasCtx.fillStyle = '#1a1a1a';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;
            for(let i = 0; i < dataArray.length; i++) {
                barHeight = (dataArray[i] / 255) * canvas.height;
                canvasCtx.fillStyle = '#1DB954';
                canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        function saveSettings() {
            const settings = { folderId: currentFolderId, folderName: currentFolderName, isShuffle: isShuffle, repeatMode: repeatMode, playScope: playScope, volume: volumeSlider.value };
            localStorage.setItem(STORE_KEY, JSON.stringify(settings));
        }

        async function loadFolders() {
            try {
                const query = `'${PARENT_ID}' in parents and mimeType = 'application/vnd.google-apps.folder'`;
                const resp = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, { headers: { 'Authorization': `Bearer ${accessToken}` } });
                if(resp.status === 401) { refreshAccessToken(); return; }
                const data = await resp.json();
                allFolders = data.files.sort((a,b)=>a.name.localeCompare(b.name,'ja'));
                const

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDrive Music Player</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; margin: 0; padding: 20px; }
        .controls, .folder-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 400px; margin: 20px auto; }
        button { background: #333; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; transition: 0.1s; font-size: 14px; }
        button:active { background: #555; transform: scale(0.95); }
        button.active { background: #1DB954; }
        .folder-btn { background: #444; border: 1px solid #666; }
        #song-title { margin: 20px 0; font-weight: bold; min-height: 1.2em; color: #1DB954; }
        #back-btn { background: #666; margin-bottom: 20px; width: 100%; max-width: 400px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>G-Drive Music</h1>
    
    <button id="auth-btn" onclick="handleAuthClick()">Googleドライブに接続</button>
    
    <div id="song-title">ログインしてください</div>

    <div id="folder-container" class="hidden">
        <h3>再生するフォルダを選択</h3>
        <div id="folder-list" class="folder-list"></div>
    </div>

    <div id="player-container" class="hidden">
        <button id="back-btn" onclick="showFolderList()">← フォルダ一覧に戻る</button>
        <div class="controls">
            <button onclick="changeMode('normal')" id="mode-normal" class="active">順次</button>
            <button onclick="changeMode('shuffle')" id="mode-shuffle">シャッフル</button>
            <button onclick="skip(-10)">-10秒</button>
            <button onclick="skip(10)">+10秒</button>
            <button onclick="prevTrack()">前へ</button>
            <button onclick="nextTrack()">次へ</button>
            <button onclick="togglePlay()" id="play-btn" style="grid-column: span 2; background: #1DB954;">再生</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // 設定
        const CLIENT_ID = '870566274257-1e240kru9vef55k8ke7odf522tn7i864.apps.googleusercontent.com';
        const PARENT_FOLDER_ID = '1t5V8v-i-cYsOG9DcDveR2SzJp1JO5Uwj'; // 親フォルダID
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        let tokenClient, accessToken = null, playlist = [], currentIndex = 0, isShuffle = false;
        const audio = document.getElementById('audio-player');

        function gapiLoaded() { gapi.load('client', () => {}); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    accessToken = resp.access_token;
                    document.getElementById('auth-btn').classList.add('hidden');
                    loadSubFolders();
                },
            });
        }

        function handleAuthClick() { tokenClient.requestAccessToken({prompt: 'consent'}); }

        // 1. サブフォルダ一覧を取得
        async function loadSubFolders() {
            document.getElementById('song-title').innerText = "フォルダを確認中...";
            try {
                const query = `'${PARENT_FOLDER_ID}' in parents and mimeType = 'application/vnd.google-apps.folder'`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await response.json();
                
                const listEl = document.getElementById('folder-list');
                listEl.innerHTML = '';
                
                if (data.files && data.files.length > 0) {
                    data.files.forEach(folder => {
                        const btn = document.createElement('button');
                        btn.className = 'folder-btn';
                        btn.innerText = folder.name;
                        btn.onclick = () => loadMusicFiles(folder.id, folder.name);
                        listEl.appendChild(btn);
                    });
                    document.getElementById('folder-container').classList.remove('hidden');
                    document.getElementById('song-title').innerText = "フォルダを選んでください";
                } else {
                    document.getElementById('song-title').innerText = "サブフォルダが見つかりません。直下のファイルを読み込みます。";
                    loadMusicFiles(PARENT_FOLDER_ID, "すべての曲");
                }
            } catch (e) { alert("フォルダ取得エラー: " + e.message); }
        }

        // 2. 選択されたフォルダ内の曲を取得
        async function loadMusicFiles(folderId, folderName) {
            document.getElementById('song-title').innerText = `${folderName} を読み込み中...`;
            try {
                const query = `'${folderId}' in parents and mimeType = 'audio/mpeg'`;
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } });
                const data = await response.json();
                playlist = data.files;

                if (playlist && playlist.length > 0) {
                    document.getElementById('folder-container').classList.add('hidden');
                    document.getElementById('player-container').classList.remove('hidden');
                    document.getElementById('song-title').innerText = `${playlist.length}曲見つかりました`;
                    playTrack(0);
                } else {
                    alert("このフォルダにはMP3ファイルがありません。");
                    loadSubFolders();
                }
            } catch (e) { alert("曲の取得エラー: " + e.message); }
        }

        function showFolderList() {
            audio.pause();
            document.getElementById('player-container').classList.add('hidden');
            loadSubFolders();
        }

        // --- 再生系ロジック（前回と同様） ---
        function playTrack(index) {
            if (playlist.length === 0) return;
            currentIndex = index;
            const track = playlist[index];
            const url = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`;
            
            fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } })
                .then(resp => resp.blob())
                .then(blob => {
                    audio.src = URL.createObjectURL(blob);
                    audio.play();
                    document.getElementById('song-title').innerText = track.name;
                    document.getElementById('play-btn').innerText = "一時停止";
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({ title: track.name });
                    }
                });
        }

        function togglePlay() {
            if (audio.paused) { audio.play(); document.getElementById('play-btn').innerText = "一時停止"; }
            else { audio.pause(); document.getElementById('play-btn').innerText = "再生"; }
        }
        function nextTrack() {
            let next = isShuffle ? Math.floor(Math.random() * playlist.length) : (currentIndex + 1) % playlist.length;
            playTrack(next);
        }
        function prevTrack() {
            let prev = (currentIndex - 1 + playlist.length) % playlist.length;
            playTrack(prev);
        }
        function skip(sec) { audio.currentTime += sec; }
        function changeMode(mode) {
            isShuffle = (mode === 'shuffle');
            document.getElementById('mode-shuffle').classList.toggle('active', isShuffle);
            document.getElementById('mode-normal').classList.toggle('active', !isShuffle);
        }
        audio.onended = nextTrack;
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>

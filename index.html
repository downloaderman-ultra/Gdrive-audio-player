<script>
    // ... (前略: 定数部分はVer.1.3と同じ)

    function playTrack(index) {
        if (playlist.length === 0) return;
        currentIndex = index;
        const track = playlist[index];
        
        document.querySelectorAll('.item-btn').forEach(el => el.classList.remove('playing'));
        const activeBtn = document.getElementById(`song-${index}`);
        if (activeBtn) {
            activeBtn.classList.add('playing');
            activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        document.getElementById('song-title').innerText = track.name;

        // ネットワーク切断対策: fetchにタイムアウトとリトライの概念を導入
        const fetchUrl = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media`;
        fetch(fetchUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } })
            .then(r => {
                if (!r.ok) throw new Error('Network error');
                return r.blob();
            })
            .then(blob => {
                if (audio.src) URL.revokeObjectURL(audio.src);
                audio.src = URL.createObjectURL(blob);
                audio.volume = 1.0;
                
                // 再生開始を確実にするためのPromise処理
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Auto-play prevented. User interaction needed.");
                    });
                }
                updateMediaSession(track.name);
            })
            .catch(err => {
                console.error("Playback failed, retrying in 3s...", err);
                setTimeout(() => playTrack(currentIndex), 3000); // 失敗時は3秒後にリトライ
            });
    }

    // MediaSession APIの強化 (OSの再生コントロールとの連携を強める)
    function updateMediaSession(title) {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title,
                artist: 'G-Drive Music',
                album: 'Streaming from Drive',
                artwork: [{ src: 'https://via.placeholder.com/512', sizes: '512x512', type: 'image/png' }]
            });

            // ハンドラを明示的にセットすることでOSに「音楽アプリ」と認識させる
            const actionHandlers = [
                ['play', () => audio.play()],
                ['pause', () => audio.pause()],
                ['previoustrack', prevTrack],
                ['nexttrack', nextTrack],
                ['seekbackward', () => skip(-10)],
                ['seekforward', () => skip(10)]
            ];

            for (const [action, handler] of actionHandlers) {
                try { navigator.mediaSession.setActionHandler(action, handler); } 
                catch (e) { console.log(e); }
            }
        }
    }
    
    // 省電力による停止を検知して復帰を試みる
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible" && audio.paused && !audio.ended && audio.src) {
            // 画面に戻った時に、もし止まっていたら再生再開を試みる
            audio.play().catch(() => {});
        }
    });
</script>
